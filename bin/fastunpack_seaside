#!/bin/bash

first_run=$1

if [ -z "$2" ]; then
  last_run=$1
else
  last_run=$2
fi

for run_num in `seq $first_run $last_run`
do
echo "Run ${run_num}"
re='^[0-9]+$'

if ! [[ $run_num =~ $re ]] ; then
   echo "Error: Invalid run number" >&2; exit 1
fi

#TEMPORARY, contingent on premanent raw/ROOT file locations
#eval '/projects/e15190/ribbit/bin/UnpackerFilter --source=file:///projects/e15190/rawfiles/\
#run-0'$run_num'-00.evt --sink=file:///dev/null'

#file_evt=$(printf run-%04d-00.evt $run_num)
i=0

for file_evt in $(ls /mnt/misc/daqevents-ro/e15190/experiment/run$run_num/*.evt); do

cat > submit.sh << EOF
#!/usr/bin/env bash
#PBS -m a
#PBS -l nodes=1:ppn=1,mem=2gb,walltime=00:20:00
#PBS -N Unpacking_${file_evt}
#PBS -j oe
#PBS -S /bin/bash
module swap GNU Intel/13.0.1.117
 
/projects/e15190/ribbitMerged/bin/UnpackerFilter --source=file://'$file_evt' --sink=file:///dev/null
EOF
   ((i++))
   qsub submit.sh
   sleep 0.5

done
done
