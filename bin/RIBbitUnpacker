#!/bin/bash

clear

first_run=$1

if [ -z "$2" ]; then
  last_run=$1
else
  last_run=$2
fi

for run_num in `seq $first_run $last_run`
do
re='^[0-9]+$'

if ! [[ $run_num =~ $re ]] ; then
   echo "Error: Invalid run number" >&2; exit 1
fi

#extracting information from configuration file from config/RIBbit2.conf
while IFS= read -r line;do
    fields=($(printf "%s" "$line"|cut --output-delimiter=' ' -f1-))
    if [ ${fields[1]} ] && [ ${fields[1]} = "EVENT_FILE_PATH" ] ; then
      if echo "${fields[2]}" | grep -q "run="; then
        run_range=($(echo ${fields[2]}|cut -d'=' -f2-))
        run_range_first=($(echo $run_range|cut -d'-' -f1))
        run_range_last=($(echo $run_range|cut -d'-' -f2))
        if [ $run_num -ge $run_range_first ] && [ $run_num -le $run_range_last ]; then
          EvtFilesPath=$(echo ${fields[3]} | sed 's/[\"]//g')
        fi
      else
        EvtFilesPath=$(echo ${fields[2]} | sed 's/[\"]//g')
      fi
    fi
    if [ ${fields[1]} ] && [ ${fields[1]} = "RIBBIT2_DIR" ] ; then
      Ribbit2Path=$(echo ${fields[2]} | sed 's/[\"]//g')
    fi
done < config/RIBbit2.conf

if [ ! -d "${EvtFilesPath}run$run_num/" ]; then #the directory of evt files does not exist
    echo "Error: missing or incorrect evt files location for run $run_num"; continue
fi

for file_evt in $(ls ${EvtFilesPath}run$run_num/*.evt); do
    eval '${Ribbit2Path}bin/RIBbitUnpacker.exe --source=file://'$file_evt' --sink=file:///dev/null'
done
done
